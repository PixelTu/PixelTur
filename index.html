<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>PixelTur</title>
<style>
  body { margin:0; background:#111; overflow:hidden; }
  canvas { background:#fff; display:block; touch-action:none; }
  #palette {
    position:fixed; bottom:0; left:0; right:0;
    background:#222; padding:8px;
    display:flex; gap:6px; overflow-x:auto; justify-content:center;
  }
  .color { width:24px; height:24px; border:1px solid #555; flex-shrink:0; }
  .selected { border:2px solid gold; }
  #cooldown {
    position:fixed; top:10px; right:10px;
    background:#222; padding:6px 10px; border-radius:6px;
    font-size:14px; font-weight:bold; color:lime;
  }
  #founder {
    position:fixed; top:10px; left:10px;
    background:#222; padding:6px 10px; border-radius:6px;
    font-size:14px; font-weight:bold; color:#FFD700;
  }

  /* Mobilde butonları büyüt */
  @media (max-width: 768px) {
    .color {
      width:50px;
      height:50px;
      border:2px solid #555;
    }
    #palette {
      gap:10px;
      padding:12px;
    }
  }
</style>
</head>
<body>

<canvas id="board"></canvas>
<div id="cooldown">Hazır!</div>
<div id="founder">Founder: Beyaz234 & TFSOO & Babapiro</div>
<div id="palette"></div>

<script>
const canvas=document.getElementById("board");
const ctx=canvas.getContext("2d");

const gridSize=200, cellSize=5;
canvas.width=gridSize*cellSize;
canvas.height=gridSize*cellSize;

/* Palet */
const colors=["#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF",
"#000000","#FFFFFF","#FFA500","#800080","#008000","#808080","#A52A2A","#ADD8E6","#FFC0CB","#FFD700"];
let currentColor=colors[0];
const palette=document.getElementById("palette");
colors.forEach(c=>{
  const div=document.createElement("div");
  div.className="color"; div.style.background=c;
  div.onclick=()=>{
    document.querySelectorAll(".color").forEach(x=>x.classList.remove("selected"));
    div.classList.add("selected"); currentColor=c;
  };
  palette.appendChild(div);
});
palette.firstChild.classList.add("selected");

/* Cooldown */
let canPlace=true; let cooldownTime=10*60;
const cooldownDiv=document.getElementById("cooldown");
function startCooldown(){
  canPlace=false; let t=cooldownTime;
  const timer=setInterval(()=>{
    t--; if(t<=0){clearInterval(timer); canPlace=true;
      cooldownDiv.textContent="Hazır!"; cooldownDiv.style.color="lime";}
    else{cooldownDiv.textContent=`${Math.floor(t/60)}:${String(t%60).padStart(2,"0")}`;
      cooldownDiv.style.color="#ff4444";}
  },1000);
}

/* WebSocket */
const socket=new WebSocket("wss://pixeltur-backend.onrender.com");
let board=[];
socket.onmessage=e=>{
  const data=JSON.parse(e.data);
  if(data.type==="init"){ board=data.board; drawBoard(); }
  if(data.type==="update"){ drawPixel(data.x,data.y,data.color); }
};

/* Çizim */
function drawBoard(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  board.forEach(p=>{
    ctx.fillStyle=p.color;
    ctx.fillRect(p.x*cellSize,p.y*cellSize,cellSize,cellSize);
  });
}
function drawPixel(x,y,color){
  ctx.fillStyle=color;
  ctx.fillRect(x*cellSize,y*cellSize,cellSize,cellSize);
}

/* Zoom state */
let scale=1;
let lastDist=0;

/* Tıklama – scale hesaba katılarak */
canvas.addEventListener("click",e=>{
  if(!canPlace)return;
  const rect=canvas.getBoundingClientRect();
  const x=Math.floor((e.clientX-rect.left)/(cellSize*scale));
  const y=Math.floor((e.clientY-rect.top)/(cellSize*scale));
  if(x>=0&&x<gridSize&&y>=0&&y<gridSize){
    socket.send(JSON.stringify({type:"place",x,y,color:currentColor}));
    startCooldown();
  }
});

/* Mobilde pinch-zoom desteği (transform ile) */
canvas.addEventListener("touchmove",e=>{
  if(e.touches.length===2){
    e.preventDefault();
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    const dist=Math.sqrt(dx*dx+dy*dy);
    if(lastDist){
      const diff=dist-lastDist;
      scale+=diff*0.001;
      scale=Math.min(Math.max(scale,0.5),3); // zoom sınırı
      canvas.style.transform=`scale(${scale})`;
      canvas.style.transformOrigin="center center";
    }
    lastDist=dist;
  }
});
canvas.addEventListener("touchend",()=>{ lastDist=0; });
</script>
</body>
</html>