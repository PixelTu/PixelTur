<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>PixelTur</title>
<style>
  body { margin:0; background:#111; overflow:hidden; }
  canvas { background:#fff; display:block; touch-action:none; }
  #palette {
    position:fixed; bottom:0; left:0; right:0;
    background:#222; padding:8px;
    display:flex; gap:6px; overflow-x:auto; justify-content:center;
  }
  .color { width:24px; height:24px; border:2px solid #555; flex-shrink:0; }
  .selected { border:2px solid gold; }
  #cooldown {
    position:fixed; top:10px; right:10px;
    background:#222; padding:6px 10px; border-radius:6px;
    font-size:14px; font-weight:bold; color:lime;
  }
  #founder {
    position:fixed; top:10px; left:10px;
    background:#222; padding:6px 10px; border-radius:6px;
    font-size:14px; font-weight:bold; color:#FFD700;
  }
  #early {
    position:fixed;
    top:50%;
    right:10px;
    transform:translateY(-50%);
    background:#222;
    color:#FFD700;
    padding:8px 12px;
    border-radius:6px;
    font-weight:bold;
  }

  /* Chat kutusu */
  #chatBox {
    position:fixed;
    bottom:60px;
    right:10px;
    width:250px;
    max-height:300px;
    background:#222;
    border:2px solid #555;
    border-radius:8px;
    display:none;
    flex-direction:column;
    z-index:999;
  }
  #chatMessages {
    flex:1;
    overflow-y:auto;
    padding:6px;
    font-size:14px;
    color:#fff;
  }
  #chatInput {
    border:none;
    padding:6px;
    width:calc(100% - 12px);
    margin:6px;
    border-radius:4px;
  }
  #chatToggle {
    position:fixed;
    bottom:370px;
    right:10px;
    background:#FFD700;
    color:#000;
    padding:6px 10px;
    border-radius:6px;
    font-weight:bold;
    cursor:pointer;
    z-index:1000;
  }

  /* Kurallar modal */
  #rulesModal {
    display:none;
    position:fixed;
    top:0; left:0; right:0; bottom:0;
    background:#000a;
    color:#fff;
    padding:20px;
    z-index:2000;
  }
  #rulesModal h2 { margin-top:0; }
  #rulesModal ul { margin:10px 0; }
</style>
</head>
<body>

<canvas id="board"></canvas>
<div id="cooldown">Hazır!</div>
<div id="founder">Founder: Beyaz234 & TFSOO & Babapiro</div>
<div id="palette"></div>
<div id="early">Erken Erişim</div>

<!-- Chat sistemi -->
<div id="chatBox">
  <div id="chatMessages"></div>
  <input id="chatInput" placeholder="Mesaj yaz..." />
</div>
<div id="chatToggle">Chat Aç/Kapat</div>

<!-- Kurallar Modal -->
<div id="rulesModal">
  <h2>Chat Kuralları</h2>
  <ul>
    <li>Küfür ve hakaret yasaktır.</li>
    <li>Spam ve flood yapmayın.</li>
    <li>Oyun dışı konuşmalardan oyun sorumlu değildir.</li>
  </ul>
  <label><input type="checkbox" id="acceptRules"> Kuralları okudum ve kabul ediyorum</label><br><br>
  <button onclick="acceptRules()">Onayla ve Chat’e Gir</button>
</div>

<script>
const canvas=document.getElementById("board");
const ctx=canvas.getContext("2d");

const gridSize=200, cellSize=5;
canvas.width=gridSize*cellSize;
canvas.height=gridSize*cellSize;

/* Palet – beyazı 2. sıraya ekledik */
const colors=["#FF0000","#FFFFFF","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF",
"#000000","#FFA500","#800080","#008000","#808080","#A52A2A","#ADD8E6","#FFC0CB","#FFD700"];
let currentColor=colors[0];
const palette=document.getElementById("palette");
colors.forEach(c=>{
  const div=document.createElement("div");
  div.className="color"; div.style.background=c;
  div.onclick=()=>{
    document.querySelectorAll(".color").forEach(x=>x.classList.remove("selected"));
    div.classList.add("selected"); currentColor=c;
  };
  palette.appendChild(div);
});
palette.firstChild.classList.add("selected");

/* Cooldown */
let canPlace=true; let cooldownTime=10*60;
const cooldownDiv=document.getElementById("cooldown");
function startCooldown(){
  canPlace=false; let t=cooldownTime;
  const timer=setInterval(()=>{
    t--; if(t<=0){clearInterval(timer); canPlace=true;
      cooldownDiv.textContent="Hazır!"; cooldownDiv.style.color="lime";}
    else{cooldownDiv.textContent=`${Math.floor(t/60)}:${String(t%60).padStart(2,"0")}`;
      cooldownDiv.style.color="#ff4444";}
  },1000);
}

/* WebSocket */
const socket=new WebSocket("wss://pixeltur-backend.onrender.com");
let board=[];
socket.onmessage=e=>{
  const data=JSON.parse(e.data);
  if(data.type==="init"){ board=data.board; drawBoard(); }
  if(data.type==="update"){ drawPixel(data.x,data.y,data.color); }
};

/* Çizim */
function drawBoard(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  board.forEach(p=>{
    ctx.fillStyle=p.color;
    ctx.fillRect(p.x*cellSize,p.y*cellSize,cellSize,cellSize);
  });
}
function drawPixel(x,y,color){
  ctx.fillStyle=color;
  ctx.fillRect(x*cellSize,y*cellSize,cellSize,cellSize);
}

/* Zoom + Pan state */
let scale=1, lastDist=0;
let isDragging=false, startX=0, startY=0, offsetX=0, offsetY=0;

function updateTransform(){
  canvas.style.transform=`translate(${offsetX}px,${offsetY}px) scale(${scale})`;
}

/* Tıklama – scale ve offset hesaba katılarak */
canvas.addEventListener("click",e=>{
  if(!canPlace)return;
  const rect=canvas.getBoundingClientRect();
  const x=Math.floor((e.clientX-rect.left-offsetX)/(cellSize*scale));
  const y=Math.floor((e.clientY-rect.top-offsetY)/(cellSize*scale));
  if(x>=0&&x<gridSize&&y>=0&&y<gridSize){
    socket.send(JSON.stringify({type:"place",x,y,color:currentColor}));
    startCooldown();
  }
});

/* PC – mouse wheel zoom */
canvas.addEventListener("wheel",e=>{
  e.preventDefault();
  scale += e.deltaY * -0.001;
  scale = Math.min(Math.max(scale,0.5),3);
  canvas.style.transformOrigin=`${e.offsetX}px ${e.offsetY}px`;
  updateTransform();
});

/* PC – pan (drag) */
canvas.addEventListener("mousedown",e=>{
  isDragging=true; startX=e.clientX-offsetX; startY=e.clientY-offsetY;
});
canvas.addEventListener("mousemove",e=>{
  if(isDragging){
    offsetX=e.clientX-startX;
    offsetY=e.clientY-startY;
    updateTransform();
  }
});
canvas.addEventListener("mouseup",()=>{isDragging=false;});
canvas.addEventListener("mouseleave",()=>{isDragging=false;});

/* Mobil – pinch zoom + pan */
canvas.addEventListener("touchmove",e=>{
  if(e.touches.length===2){
    e.preventDefault();
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    const dist=Math.sqrt(dx*dx+dy*dy);
    if(lastDist){
      const diff=dist-lastDist;
      scale+=diff*0.001;
      scale=Math.min(Math.max(scale,0.5),3);
      const midX=(e.touches[0].clientX+e.touches[1].clientX)/2;
      const midY=(e.touches[0].clientY+e.touches[1].clientY)/2;
      const